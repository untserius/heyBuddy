<!DOCTYPE html>
<html>
<head>
  <title>WebRTC 1-on-1 Test</title>
  <style>
    video {
      width: 45%;
      border: 1px solid #ccc;
      margin: 5px;
    }
  </style>
</head>
<body>

<button onclick="start('B')">Start as B</button>
<button onclick="start('A')">Start as A</button>

<br/><br/>

<video id="local" autoplay muted playsinline></video>
<video id="remote" autoplay playsinline></video>

<script>
let ws, pc, role, other;
let remoteDescSet = false;
const pendingCandidates = [];

function start(r) {
  role = r;
  other = role === 'A' ? 'B' : 'A';

  console.log("Starting as", role);

  ws = new WebSocket(`ws://192.168.123.41:8080/ws/signaling?userId=${role}`);

  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
    iceCandidatePoolSize: 10
  });

  // ðŸ”¥ FORCE ICE START (important)
  pc.createDataChannel("debug");

  pc.ontrack = e => {
    console.log("Remote track received");
    remote.srcObject = e.streams[0];
  };

  pc.onicecandidate = e => {
    console.log("ICE candidate:", e.candidate);
    if (e.candidate) {
      ws.send(JSON.stringify({
        type: "ICE",
        callId: "call1",
        from: role,
        to: other,
        payload: e.candidate
      }));
    }
  };

  pc.oniceconnectionstatechange = () => {
    console.log("ICE state:", pc.iceConnectionState);
  };

  pc.onconnectionstatechange = () => {
    console.log("PC state:", pc.connectionState);
  };

  navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(stream => {
      console.log("Got media stream");
      local.srcObject = stream;
      stream.getTracks().forEach(t => pc.addTrack(t, stream));
      console.log("Senders:", pc.getSenders());
    })
    .catch(err => console.error("getUserMedia failed", err));

  ws.onopen = () => {
    ws.send(JSON.stringify({
      type: "JOIN",
      callId: "call1",
      from: role
    }));
  };

  ws.onmessage = async e => {
    const msg = JSON.parse(e.data);

    if (msg.type === "READY" && role === "A") {
      console.log("READY received â†’ creating OFFER");

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      ws.send(JSON.stringify({
        type: "OFFER",
        callId: "call1",
        from: "A",
        to: "B",
        payload: {
          type: offer.type,
          sdp: offer.sdp
        }
      }));
    }

    if (msg.type === "OFFER" && role === "B") {
      console.log("OFFER received");

      await pc.setRemoteDescription(
        new RTCSessionDescription(msg.payload)
      );
      remoteDescSet = true;

      for (const c of pendingCandidates) {
        await pc.addIceCandidate(c);
      }
      pendingCandidates.length = 0;

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      ws.send(JSON.stringify({
        type: "ANSWER",
        callId: "call1",
        from: "B",
        to: "A",
        payload: {
          type: answer.type,
          sdp: answer.sdp
        }
      }));
    }

    if (msg.type === "ANSWER") {
      console.log("ANSWER received");

      await pc.setRemoteDescription(
        new RTCSessionDescription(msg.payload)
      );
      remoteDescSet = true;

      for (const c of pendingCandidates) {
        await pc.addIceCandidate(c);
      }
      pendingCandidates.length = 0;
    }

    if (msg.type === "ICE") {
      if (remoteDescSet) {
        await pc.addIceCandidate(msg.payload);
      } else {
        pendingCandidates.push(msg.payload);
      }
    }
  };
}
</script>

</body>
</html>
